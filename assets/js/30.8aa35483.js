(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{539:function(a,t,s){"use strict";s.r(t);var n={props:["slot-key"],mounted:function(){this.$nextTick(function(){this.$vuepress.$emit("AsyncMarkdownContentMounted",this.slotKey)})}},e=s(2),o=Object(e.a)(n,function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.slotKey}},[s("h1",{attrs:{id:"debug"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#debug","aria-hidden":"true"}},[a._v("#")]),a._v(" Debug")]),a._v(" "),s("hr"),a._v(" "),s("h3",{attrs:{id:"排查oom"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#排查oom","aria-hidden":"true"}},[a._v("#")]),a._v(" 排查OOM")]),a._v(" "),s("p",[a._v("OOM，最常见的原因为:")]),a._v(" "),s("ul",[s("li",[a._v("内存分配确实过小，而正常业务使用了大量内存")]),a._v(" "),s("li",[a._v("某一个对象被频繁申请，却没有释放，内存不断泄漏，导致内存耗尽")]),a._v(" "),s("li",[a._v("某一个资源被频繁申请，系统资源耗尽，例如：不断创建线程，不断发起网络连接")])]),a._v(" "),s("p",[s("code",[a._v("ps: 无非“本身资源不够”,“申请资源太多”,“资源耗尽”几个原因")])]),a._v(" "),s("ol",[s("li",[s("p",[a._v("确认是不是内存本身就分配过小")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ jmap -heap 11897\n\nAttaching to process ID 11897, please wait"),s("span",{attrs:{class:"token punctuation"}},[a._v("..")]),a._v(".\nDebugger attached successfully.\nServer compiler detected.\nJVM version is 25.201-b09\n\nusing thread-local object allocation.\nParallel GC with 2 thread"),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("s"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\nHeap Configuration:\n   MinHeapFreeRatio         "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 0\n   MaxHeapFreeRatio         "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 100\n   MaxHeapSize              "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 994050048 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("948.0MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   NewSize                  "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 20971520 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("20.0MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   MaxNewSize               "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 331350016 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("316.0MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   OldSize                  "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 41943040 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("40.0MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   NewRatio                 "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 2\n   SurvivorRatio            "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 8\n   MetaspaceSize            "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 21807104 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("20.796875MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   CompressedClassSpaceSize "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 1073741824 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("1024.0MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   MaxMetaspaceSize         "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 17592186044415 MB\n   G1HeapRegionSize         "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 0 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("0.0MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\nHeap Usage:\nPS Young Generation\nEden Space:\n   capacity "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 138412032 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("132.0MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   used     "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 124075208 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("118.32733917236328MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   "),s("span",{attrs:{class:"token function"}},[a._v("free")]),a._v("     "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 14336824 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("13.672660827636719MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   89.64192361542673% used\nFrom Space:\n   capacity "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 1048576 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("1.0MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   used     "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 737840 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("0.7036590576171875MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   "),s("span",{attrs:{class:"token function"}},[a._v("free")]),a._v("     "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 310736 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("0.2963409423828125MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   70.36590576171875% used\nTo Space:\n   capacity "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 6815744 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("6.5MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   used     "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 0 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("0.0MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   "),s("span",{attrs:{class:"token function"}},[a._v("free")]),a._v("     "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 6815744 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("6.5MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   0.0% used\nPS Old Generation\n   capacity "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 662700032 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("632.0MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   used     "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 647653448 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("617.6504592895508MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   "),s("span",{attrs:{class:"token function"}},[a._v("free")]),a._v("     "),s("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" 15046584 "),s("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("14.349540710449219MB"),s("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n   97.72950305214411% used\n")])])])]),a._v(" "),s("li",[s("p",[a._v("找到最耗内存的对象")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ jmap -histo:live 11897 "),s("span",{attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{attrs:{class:"token function"}},[a._v("more")]),a._v("\n         \n num     "),s("span",{attrs:{class:"token comment"}},[a._v("#instances         #bytes  class name")]),a._v("\n----------------------------------------------\n   1:       1494121      134108856  "),s("span",{attrs:{class:"token punctuation"}},[a._v("[")]),a._v("C\n   2:        603943       53146984  java.lang.reflect.Method\n   3:       1167591       37362912  java.util.concurrent.ConcurrentHashMap"),s("span",{attrs:{class:"token variable"}},[a._v("$Node")]),a._v("\n   4:       1488224       35717376  java.lang.String\n   5:        542736       35549048  "),s("span",{attrs:{class:"token punctuation"}},[a._v("[")]),a._v("Ljava.lang.Object"),s("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n   6:        835229       33409160  java.util.LinkedHashMap"),s("span",{attrs:{class:"token variable"}},[a._v("$Entry")]),a._v("\n   7:        206555       23429528  java.lang.Class\n   8:        267657       19133392  "),s("span",{attrs:{class:"token punctuation"}},[a._v("[")]),a._v("Ljava.util.HashMap"),s("span",{attrs:{class:"token variable"}},[a._v("$Node")]),s("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n   9:        278592       15601152  java.util.LinkedHashMap\n  10:         68071       14952936  "),s("span",{attrs:{class:"token punctuation"}},[a._v("[")]),a._v("B\n  11:        503312       12079488  java.util.ArrayList\n  12:          5931       11884192  "),s("span",{attrs:{class:"token punctuation"}},[a._v("[")]),a._v("Ljava.util.concurrent.ConcurrentHashMap"),s("span",{attrs:{class:"token variable"}},[a._v("$Node")]),s("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n  13:        237493        7599776  java.util.HashMap"),s("span",{attrs:{class:"token variable"}},[a._v("$Node")]),a._v("\n  14:        264970        5859048  "),s("span",{attrs:{class:"token punctuation"}},[a._v("[")]),a._v("Ljava.lang.Class"),s("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n  15:        283757        4540112  java.lang.Object\n  16:         82139        4525200  "),s("span",{attrs:{class:"token punctuation"}},[a._v("[")]),a._v("I\n  17:         74989        3599472  java.util.HashMap\n  18:        123002        3291616  "),s("span",{attrs:{class:"token punctuation"}},[a._v("[")]),a._v("Ljava.lang.String"),s("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n  19:         38106        2743632  java.lang.reflect.Field\n  20:         63147        2525880  java.lang.ref.SoftReference\n  21:         92884        2229216  sun.reflect.generics.tree.SimpleClassTypeSignature\n  22:         26064        2085120  java.lang.reflect.Constructor\n  23:         64346        2059072  java.util.LinkedList\n  24:         64061        2049952  java.lang.ref.WeakReference\n  25:         77475        1859400  java.util.LinkedList"),s("span",{attrs:{class:"token variable"}},[a._v("$Node")]),a._v("\n  26:         92884        1749976  "),s("span",{attrs:{class:"token punctuation"}},[a._v("[")]),a._v("Lsun.reflect.generics.tree.TypeArgument"),s("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n  27:         69959        1679016  sun.reflect.annotation.AnnotationInvocationHandler\n  28:        101073        1617168  java.util.LinkedHashMap"),s("span",{attrs:{class:"token variable"}},[a._v("$LinkedEntrySet")]),a._v("\n")])])]),s("ul",[s("li",[a._v("如果发现某类对象占用内存很大（例如几个G），很可能是类对象创建太多，且一直未释放。例如：\n"),s("ul",[s("li",[a._v("申请完资源后，未调用close()或dispose()释放资源")]),a._v(" "),s("li",[a._v("消费者消费速度慢（或停止消费了），而生产者不断往队列中投递任务，导致队列中任务累积过多")])])])]),a._v(" "),s("p",[s("code",[a._v("ps：线上执行该命令会强制执行一次fgc。另外还可以dump内存进行分析。")])])]),a._v(" "),s("li",[s("p",[a._v("确认是否是资源耗尽"),s("br"),a._v("\n工具：")]),a._v(" "),s("ul",[s("li",[a._v("pstree")]),a._v(" "),s("li",[a._v("netstat")])])])]),a._v(" "),s("ul",[s("li",[s("p",[a._v("查看进程创建的线程数，以及网络连接数，如果资源耗尽，也可能出现OOM")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ ll /proc/"),s("span",{attrs:{class:"token variable"}},[a._v("${PID}")]),a._v("/fd        "),s("span",{attrs:{class:"token comment"}},[a._v("#查看句柄详情 or pstree -p ${PID} | wc -l")]),a._v("\n$ ll /proc/"),s("span",{attrs:{class:"token variable"}},[a._v("${PID}")]),a._v("/task      "),s("span",{attrs:{class:"token comment"}},[a._v("#查看线程数")]),a._v("\n")])])])]),a._v(" "),s("li",[s("p",[a._v("例如，某一台线上服务器的sshd进程PID是4943")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ ll /proc/4943/fd\n总用量 0\nlr-x------ 1 root root 64 11月 27 15:24 0 -"),s("span",{attrs:{class:"token operator"}},[a._v(">")]),a._v(" /dev/null\nlrwx------ 1 root root 64 11月 27 15:24 1 -"),s("span",{attrs:{class:"token operator"}},[a._v(">")]),a._v(" /dev/null\nlrwx------ 1 root root 64 11月 27 15:24 2 -"),s("span",{attrs:{class:"token operator"}},[a._v(">")]),a._v(" /dev/null\nlrwx------ 1 root root 64 11月 27 15:24 3 -"),s("span",{attrs:{class:"token operator"}},[a._v(">")]),a._v(" socket:"),s("span",{attrs:{class:"token punctuation"}},[a._v("[")]),a._v("21019"),s("span",{attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n\n$ ll /proc/4943/task\n总用量 0\ndr-xr-xr-x 7 root root 0 11月 21 15:08 4943 \n")])])])]),a._v(" "),s("li",[s("p",[a._v("如上，sshd共占用了四个句柄")]),a._v(" "),s("ul",[s("li",[a._v("0 -> 标准输入")]),a._v(" "),s("li",[a._v("1 -> 标准输出")]),a._v(" "),s("li",[a._v("2 -> 标准错误输出")]),a._v(" "),s("li",[a._v("3 -> socket（容易想到是监听端口）")])]),a._v(" "),s("p",[a._v("且sshd只有一个主线程PID为4943，并没有多线程。")])])])])},[],!1,null,null,null);o.options.__file="debug.md";t.default=o.exports}}]);